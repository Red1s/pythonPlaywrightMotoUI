name: Playwright UI tests (Docker + Allure)

on:
  push:
    branches:
      - main
      - ci/github-actions
  pull_request:
    branches:
      - main

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # Забираем код
      - name: Checkout repository
        uses: actions/checkout@v5

      # Запускаем тесты через docker-compose
      # || true — чтобы отчёт собирался даже при падении тестов
      - name: Run UI tests via docker-compose
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN: ${{ secrets.LOGIN }}
          PASSWORD: ${{ secrets.E2E_PASSWORD }}
          EMAIL_FOR_SEND_TEST: ${{ secrets.EMAIL_FOR_SEND_TEST }}
        run: |
          docker-compose up --build --exit-code-from regression || true

      # Генерируем Allure-отчёт (в контейнере)
      - name: Generate Allure report
        if: always()
        run: |
          docker-compose run regression /bin/sh -c \
            "allure generate allure-results --clean -o allure-report"

      # Деплой Allure в GitHub Pages (через CI_TOKEN)
      - name: Deploy Allure to GitHub Pages
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.CI_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true