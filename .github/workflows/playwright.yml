name: Playwright UI tests (Docker + Allure)

on:
  push:
    branches:
      - main
      - ci/github-actions
  pull_request:
    branches:
      - main

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1 Get the code
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2 Run tests via docker-compose
      # || true â€” to compile the report even if the tests fail
      - name: Run UI tests via docker-compose
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN: ${{ secrets.LOGIN }}
          PASSWORD: ${{ secrets.E2E_PASSWORD }}
          EMAIL_FOR_SEND_TEST: ${{ secrets.EMAIL_FOR_SEND_TEST }}
        run: |
          docker compose up --build --exit-code-from regression || true

       # 3
      - name: Prepare Allure directories
        if: always()
        # 3.1 We guarantee the availability of the folder
        # 3.2 Ensure Allure directories are writable for any container user
        run: |
          mkdir -p allure-results allure-report 
          chmod -R 777 allure-results allure-report

      # 4 Generate Allure report from allure-results
      # Uses a dedicated Allure container (no Java in test image)
      - name: Generate Allure report
        if: always()
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/allure-results \
            -v ${{ github.workspace }}/allure-report:/allure-report \
            frankescobar/allure-docker-service \
            allure generate /allure-results --clean -o /allure-report

      # 5 Deploy Allure in GitHub Pages (through CI_TOKEN)
      - name: Deploy Allure to GitHub Pages
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.CI_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true