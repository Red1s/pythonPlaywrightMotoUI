name: Playwright UI tests (Docker + Allure)

on:
  push:
    branches:
      - main
      - ci/github-actions
  pull_request:
    branches:
      - main

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1 Get the code
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2 Run tests via docker-compose
      # || true â€” to compile the report even if the tests fail
      - name: Run UI tests via docker-compose
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN: ${{ secrets.LOGIN }}
          PASSWORD: ${{ secrets.PASSWORD }}
          EMAIL_FOR_SEND_TEST: ${{ secrets.EMAIL_FOR_SEND_TEST }}
        run: |
          docker compose up --build --exit-code-from regression || true

       # 3 Checkout gh-pages branch to restore Allure history
      - name: Checkout gh-pages for Allure history
        if: always()
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages

      - name: Prepare Allure directories
        if: always()
        # 3.1 We guarantee the availability of the folder
        # 3.2 Allow Allure container to write the HTML report
        run: |
          mkdir -p allure-results allure-report 
          chmod -R a+rwx allure-report


      # 3 Checkout gh-pages branch to restore Allure history
      - name: Checkout gh-pages for Allure history
        if: always()
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages

      # 4 Restore Allure history (if exists)
      - name: Restore Allure history
        if: always()
        run: |
          mkdir -p allure-results/history
          if [ -d "gh-pages/history" ]; then
            cp -r gh-pages/history/* allure-results/history/
          fi

      # 5 Prepare Allure report directory
      # We only grant write permissions to allure-report
      - name: Prepare Allure report directory
        if: always()
        run: |
          mkdir -p allure-report
          chmod -R a+rwx allure-report

      # 6 Generate Allure report from allure-results
      # Uses a dedicated Allure container (no Java in test image)
      - name: Generate Allure report
        if: always()
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/allure-results \
            -v ${{ github.workspace }}/allure-report:/allure-report \
            frankescobar/allure-docker-service \
            allure generate /allure-results --clean -o /allure-report

      # 7 Deploy Allure in GitHub Pages (through CI_TOKEN)
      - name: Deploy Allure to GitHub Pages
        if: always()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.CI_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true